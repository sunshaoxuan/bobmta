# 璁″垝鑺傜偣鎵ц涓庢彁閱掓搷浣滄帴鍙ｉ渶姹傝鏄?

## 鑳屾櫙

鍓嶇鍦ㄨ凯浠?#2 涓氦浠樹簡鑺傜偣鎵ц鎿嶄綔闈㈡澘涓庢彁閱掗厤缃潰鏉跨殑浜や簰鍗犱綅锛岄〉闈㈣兘澶熷垪鍑哄綋鍓嶅彲鎵ц鐨勮妭鐐瑰苟灞曠ず鎻愰啋绛栫暐鎽樿銆備负缁х画鎺ㄨ繘涓氬姟鐢婚潰锛岄渶瑕佸悗绔彁渚涜妭鐐规墽琛屼笌鎻愰啋寮€鍏崇殑鐪熷疄鎺ュ彛锛屼互渚挎浛鎹㈢洰鍓嶇殑鏈湴鐘舵€佹ā鎷熷苟瀹屾垚绔埌绔獙璇併€?

## 鍔熻兘鍦烘櫙

1. **鑺傜偣鍚姩/瀹屾垚**锛氬湪璇︽儏椤典腑瀵瑰浜?`PENDING` 鎴?`IN_PROGRESS` 鐘舵€佺殑鑺傜偣瑙﹀彂鈥滃紑濮嬫墽琛屸€濇垨鈥滃畬鎴愭墽琛屸€濇搷浣滐紝骞惰繑鍥炴洿鏂板悗鐨勮妭鐐规爲銆佹椂闂寸嚎涓庢彁閱掓憳瑕併€?
2. **鑺傜偣浜ゆ帴**锛氬綋鑺傜偣鎷ユ湁鎵ц浜烘椂鍏佽鍙戣捣浜ゆ帴鎿嶄綔锛屾寚瀹氭柊鐨勮礋璐ｄ汉骞跺啓鍏ュ娉紝鍝嶅簲闇€鍥炰紶鏈€鏂扮殑鑺傜偣璐ｄ换浜轰俊鎭€?
3. **鎻愰啋鍚仠涓庣紪杈戝崰浣?*锛氱偣鍑绘彁閱掑崱鐗囦笂鐨勨€滅紪杈戔€濃€滃惎鐢?鍋滅敤鈥濇椂锛屽簲璋冪敤鍚庣鎺ュ彛淇敼鎻愰啋绛栫暐鐨勭姸鎬佹垨鍐呭锛屽苟杩斿洖鏇存柊鍚庣殑鎻愰啋鍒楄〃渚涢〉闈㈠悓姝ョ紦瀛樸€?
4. **鑺傜偣鎵ц鍔ㄤ綔涓庨槇鍊?*锛氳妭鐐瑰畾涔夌幇鍦ㄦ惡甯?`actionType`锛堟灇涓撅細`NONE`/`REMOTE`/`EMAIL`/`IM`/`LINK`/`FILE`锛変互鍙?`completionThreshold`锛?锝?00锛夛紝鍚庣浼氬湪瀛愯妭鐐硅揪鍒伴槇鍊兼椂鑷姩琛ラ綈鐖惰妭鐐瑰畬鎴愬苟璺宠繃鍓╀綑鍙€夎妭鐐广€?

### 鑺傜偣鍔ㄤ綔鑷姩鍖?

- 褰撹妭鐐瑰浜?`EMAIL`銆乣IM`銆乣LINK`銆乣REMOTE` 鎴?`API_CALL` 绫诲瀷鏃讹紝`PlanService` 浼氬湪 `startNode`/`completeNode`/`handoverNode` 娴佺▼涓皟鐢ㄦā鏉挎湇鍔℃覆鏌撲笂涓嬫枃锛堣鍒扞D銆佽鍒掔姸鎬併€佽妭鐐瑰悕绉般€佽妭鐐硅矗浠讳汉銆佹搷浣滆€呫€佽Е鍙戞潵婧愩€佹墽琛岀粨鏋滅瓑锛夛紝闅忓悗閫氳繃閫氱煡缃戝叧娲惧彂閭欢鎴栧嵆鏃舵秷鎭紝鐢熸垚鐢ㄤ簬杩滅▼/閾炬帴绫诲姩浣滅殑鐩爣鍦板潃锛屾垨鍚戝閮ㄥ伐浣滄祦/鑷姩鍖栧钩鍙板彂璧?API 璋冪敤銆?
- 姣忔鑷姩鍖栨墽琛岄兘浼氳褰曞埌鏂扮殑 `PlanActionHistory` 浠撳偍涓紝瀛楁鍖呮嫭鍔ㄤ綔绫诲瀷銆佹ā鏉垮紩鐢ㄣ€佹墽琛岀姸鎬併€佷笂涓嬫枃锛堣鍒?鑺傜偣/鎿嶄綔鑰呯瓑锛変笌閿欒淇℃伅锛屼究浜庡璁°€俙metadata` 瀛楁浼氳惤鐩樻ā鏉夸笌缃戝叧杩斿洖鐨勮鎯咃紝濡?`attempts`锛堥噸璇曟鏁帮級銆乣endpoint`锛堥摼鎺ユ垨杩滅▼浼氳瘽鍦板潃锛夈€乣artifactName`锛堣繙绋嬭剼鏈?闄勪欢鍚嶏級銆乣provider`锛堥偖浠?IM 鏈嶅姟鍟嗭級绛夛紝渚涜繍钀ヨ拷婧€?
- API 璋冪敤鍦烘櫙浼氬皢妯℃澘 `metadata` 涓潪鏁忔劅閿紙濡?`method`銆乣scenario` 绛夛級涓庨€氱煡缃戝叧杩斿洖鍊煎啓鍏ュ巻鍙诧紝骞惰繃婊ゆ帀浠?`header.` 寮€澶寸殑鏁忔劅棣栭儴鍐呭锛屾渶缁堝湪鏃堕棿绾夸腑浠?`meta.method`銆乣meta.endpoint`銆乣meta.status` 绛夊瓧娈典緵鍓嶇灞曠ず锛涜嫢妯℃澘缂哄け `endpoint` 鍒欑洿鎺ヤ互澶辫触鍐欏叆鍘嗗彶骞舵彁绀?`plan.error.nodeActionApiEndpointMissing`銆?
- 鏃堕棿绾挎柊澧?`NODE_ACTION_EXECUTED` 浜嬩欢锛屽墠绔彲渚濇嵁 `actionStatus`銆乣actionMessage`銆乣actionError`銆乣meta.*`锛堟ā鏉?缃戝叧鍏冩暟鎹€佸皾璇曟鏁般€佽繙绋嬩細璇濆湴鍧€銆佺敓鎴愮殑鐭ヨ瘑搴撻摼鎺ョ瓑锛変笌 `context.*`锛堣鍒掋€佽妭鐐广€佽矗浠讳汉銆佽Е鍙戞潵婧愩€佹墽琛岀粨鏋滅瓑锛夊睘鎬у睍绀烘垚鍔?澶辫触璇︽儏骞舵敮鎸佺瓫閫夛紱浜嬩欢涓柊澧炵殑 `actionId` 瀛楁涓?`PlanActionHistory` 涓婚敭瀵归綈锛屼究浜庣偣鍑绘椂闂寸嚎鐩存帴璺宠浆鎴栬姹傚畬鏁村巻鍙茶褰曘€傜己澶遍摼鎺ョ殑鍦烘櫙浼氳繑鍥?`actionStatus = SKIPPED` 骞堕檮甯﹂粯璁ら敊璇枃妗?`plan.error.nodeActionLinkMissing`锛屼究浜庢彁绀轰汉宸ヨˉ褰曘€?
- 褰撻€氱煡缃戝叧杩斿洖澶辫触銆佹棤鍝嶅簲鎴栨ā鏉挎覆鏌撳紓甯告椂锛屾湇鍔′細鎸夐€氶亾鑷姩閲嶈瘯鑷冲 3 娆★紝骞跺湪 `metadata.attempts` 涓褰曞皾璇曟鏁般€傝嫢浠嶅け璐ュ垯浠ュけ璐ョ姸鎬佸啓鍏ュ巻鍙蹭笌鏃堕棿绾匡紝鍚屾椂閫氳繃 `metadata.reason` 鏍囪鍏蜂綋鍘熷洜锛堝 `EXCEPTION`銆乣NO_RESPONSE`锛夛紝璁″垝鐘舵€佹洿鏂颁粛浼氭彁浜わ紝渚夸簬鍓嶇鎻愮ず骞跺厑璁哥敤鎴峰彂璧蜂汉宸ラ噸璇曘€?
- 褰撹妭鐐瑰姩浣滅被鍨嬩负 `FILE` 鏃讹紝绯荤粺涓嶄細瑙﹀彂浠讳綍缃戝叧鎴栨ā鏉挎覆鏌擄紝鎵ц浼氫互 `actionStatus = SKIPPED` 鍐欏叆鍔ㄤ綔鍘嗗彶涓庢椂闂寸嚎锛屽苟鍦?`metadata.reason`
  瀛楁鏍囪 `NOT_SUPPORTED`锛屾彁閱掓搷浣滆€呮敼涓轰汉宸ュ鐞嗐€?

## 鎺ュ彛濂戠害鑽夋

| 鎿嶄綔 | HTTP 鏂规硶 | 璺緞 | 璇锋眰浣?| 鍝嶅簲 | 澶囨敞 |
| --- | --- | --- | --- | --- | --- |
| 鍚姩鑺傜偣 | POST | `/api/v1/plans/{planId}/nodes/{nodeId}/start` | `{ "operatorId": string }` | `PlanDetailPayload` | 瑙﹀彂鎴愬姛鍚庨渶鏇存柊鏃堕棿绾夸笌鑺傜偣鐘舵€?|
| 瀹屾垚鑺傜偣 | POST | `/api/v1/plans/{planId}/nodes/{nodeId}/complete` | `{ "operatorId": string, "resultSummary"?: string }` | `PlanDetailPayload` | 褰撳瓙鑺傜偣杈惧埌鐖惰妭鐐?`completionThreshold` 鏃讹紝鍝嶅簲浼氭惡甯︾埗鑺傜偣鐨勮嚜鍔ㄥ畬鎴愪笌琚烦杩囩殑鍏勫紵鑺傜偣 |
| 鑺傜偣浜ゆ帴 | POST | `/api/v1/plans/{planId}/nodes/{nodeId}/handover` | `{ "operatorId": string, "assigneeId": string, "comment"?: string }` | `PlanDetailPayload` | 闇€鏍￠獙鑺傜偣鍏佽浜ゆ帴鐨勭姸鎬?|
| 鏇存柊鎻愰啋 | PUT | `/api/v1/plans/{planId}/reminders/{reminderId}` | `{ "active": boolean, "offsetMinutes"?: number }` | `PlanDetailPayload` | 鍓嶇褰撳墠浠呴渶瑕佸惎鍋滆兘鍔涳紝鍚庣画鍙嫇灞曞瓧娈?|
| 鑾峰彇鍔ㄤ綔鍘嗗彶 | GET | `/api/v1/plans/{planId}/actions` | 鏃?| `PlanActionHistory[]` | 杩斿洖鏈€杩戠殑鍔ㄤ綔鎵ц鍘嗗彶锛屽垪琛ㄦ寜瑙﹀彂鏃堕棿鍗囧簭锛屽厓绱犲寘鍚?`context.*` 涓?`meta.*` 璇︽儏锛屼究浜庡墠绔覆鏌撴椂闂寸嚎鎴栨函婧?|

杩斿洖缁撴瀯寤鸿澶嶇敤 `PlanDetailPayload`锛屼互渚垮墠绔敤鍚屼竴缂撳瓨鍐欏叆閫昏緫瑕嗙洊鑺傜偣銆佹椂闂寸嚎涓庢彁閱掓渶鏂板€笺€?

## 鏁版嵁涓庢潈闄愯姹?

- 鎵€鏈夋帴鍙ｉ渶瑕佷娇鐢ㄧ幇鏈夌殑 Token 閴存潈锛屽苟鏍￠獙鎿嶄綔鑰呭叿澶囪鍒掓墽琛屾垨绠＄悊鍛樻潈闄愩€?
- 鑺傜偣鎿嶄綔闇€鏍￠獙璁″垝鐘舵€侊紙渚嬪浠呭厑璁稿凡鍙戝竷璁″垝鎵ц锛夛紝澶辫触鏃惰繑鍥炴爣鍑嗛敊璇爜鍙婂璇█鎻愮ず閿€笺€?
- 鎻愰啋鏇存柊闇€淇濈暀鎿嶄綔瀹¤锛屽啓鍏ユ椂闂寸嚎浜嬩欢渚涘墠绔睍绀恒€?
- 鑷姩闃堝€煎鐞嗕細鍦ㄦ椂闂寸嚎涓婂啓鍏?`plan.activity.nodeAutoCompleted` 涓?`plan.activity.nodeSkipped` 浜嬩欢锛屽墠绔彲鎹鎻愮ず鈥滅郴缁熻嚜鍔ㄥ畬鎴?璺宠繃鈥濆師鍥犮€?
## 持久化与审计

- 自 Flyway `V7__plan_action_history.sql` 起，节点自动化执行历史会写入 `mt_plan_action_history` 表，并与 `mt_plan`、`mt_plan_node` 外键绑定；当计划被删除时对应的历史会自动清理。
- `PlanPersistenceActionHistoryRepository` 通过 MyBatis `PlanActionHistoryMapper` 统一处理写入/查询，新增的 Testcontainers 用例 `PlanActionHistoryPersistenceIntegrationTest` 覆盖持久化与清理流程。
- `/api/v1/plans/{id}/actions` 默认按触发时间升序返回数据库中的历史记录，前端在刷新缓存时无需额外幂等判断，只需对比 `actionId`。


## Mock 绛栫暐

鍦ㄥ悗绔氦浠樺墠锛屽墠绔户缁娇鐢?`frontend/src/mocks/planDetail.ts` 涓殑鑺傜偣涓庢彁閱掔ず渚嬶紝閫氳繃鏈湴鐘舵€佹ā鎷熸寜閽弽棣堬紝骞跺湪 `frontend/tests/planNodes.test.mjs` 涓牎楠岃妭鐐圭瓫閫夐€昏緫銆傛帴鍙ｈ仈璋冨畬鎴愬悗灏嗘浛鎹负鐪熷疄璋冪敤骞舵墿灞曞崟娴嬭鐩栨帴鍙ｉ敊璇垎鏀€?

## 鐘舵€佹洿鏂?

- 鉁?鍚庣宸蹭氦浠樿妭鐐规墽琛屼笌鎻愰啋鏇存柊鎺ュ彛锛屽墠绔鍒掕鎯呴潰鏉跨幇宸插垏鎹负鐪熷疄璋冪敤骞朵繚鐣欑紦瀛樺洖閫€閫昏緫锛屽悗缁仈璋冨皢閲嶇偣楠岃瘉閿欒鐮佷笌鏉冮檺鎻愮ず銆?
- 馃攧 鍓嶇宸插畬鎴愭潈闄?閿欒鐮佽仈璋冿紝骞惰ˉ鍏呭け璐ユ€侀噸璇曟寜閽€佸弬鏁板洖濉叆鍙ｅ強鏃堕棿绾跨被鍒瓫閫夋彁绀猴紱涓嬩竴闃舵灏嗚仛鐒﹁鍒掕鎯呰矾鐢变笌鍒楄〃绛涢€夐噸鏋勭殑鍗忓悓瑙勫垝銆?
