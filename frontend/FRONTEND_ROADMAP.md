# 前端迭代路线图

本路线图用于跟踪运维计划前端在阶段四的研发任务，与后端 README 中的进度同步结构保持一致。所有进度更新需同步回根目录 `README.md` 的「前端阶段四迭代进度」章节。

## 愿景
- 提供与后端 REST API 对齐的运维计划驾驶舱体验，支持登录鉴权、计划筛选、详情浏览及提醒配置的可视化操作。
- 在前端层面贯彻国际化、多租户与权限隔离的设计，确保多语言资源、错误提示与鉴权态一致。
- 建立稳定的状态管理、Mock 流程与自动化测试基线，为即将到来的数据库与外部服务联调做好准备。

## 目标
1. **状态管理**：按模块拆分鉴权、运维计划列表、计划详情与提醒策略的状态，结合缓存/刷新策略减少接口压力。
2. **交互体验**：提供 Loading/Empty/Error 统一处理、前端分页与筛选控件，支持多语言资源切换。
3. **测试保障**：通过单元测试与（可选的）组件故事/端到端测试覆盖关键流程；后端未交付的能力需以 Mock 数据覆盖。
4. **协同机制**：所有接口需求、Mock 约定及联调结果记录在 `frontend/FRONTEND_REQUIREMENTS.md`，确保前后端信息对称。

## 环境基线
- 离线依赖：受限于内网无法访问公共 NPM 仓库，所有第三方依赖已预置在 `vendor/` 目录并通过相对路径引入，执行 `npm install` 不会触发下载。
- 编译流程：使用内置 TypeScript 编译（`npm run build`）生成 `dist/` 产物，`npm run preview` 可启动静态服务器加载 `index.html`、`dist/` 与 `vendor/`。
- 变更约束：升级或新增依赖需先在《`frontend/FRONTEND_REQUIREMENTS.md`》登记并评估离线镜像方案，避免破坏现有离线链路。

## 迭代规划

### 迭代 #1 — 协同规范与需求盘点（已完成）
- **范围**：输出前后端协作规范、建立需求清单与路线图，盘点当前登录与计划列表的改造需求。
- **交付物**：
  - 更新根目录 README 协同章节。
  - `frontend/FRONTEND_REQUIREMENTS.md` 初始化需求表。
  - 本路线图文档。
- **验证**：文档通过 Review，后续迭代据此执行。
- **进展摘要**：2025-09-28 完成，协同规范及离线环境基线已同步至 README 与专属文档。

### 迭代 #2 — 状态管理与请求封装（进行中）
- **范围**：抽象 API 客户端与错误处理，拆分登录会话、计划列表及多语言缓存状态。
- **预期实现**：
  - 基于 React Context 或轻量状态库（例如 Zustand/TanStack Query，待评估）搭建数据层。
  - 提供请求封装模块，集中处理 `Accept-Language`、鉴权头与错误映射。
  - 引入 Mock 层支撑未完成接口的单元测试（可考虑 MSW 或自定义模拟）。
- **验证**：
  - 单元测试覆盖登录成功/失败、计划列表加载与错误分支。
  - README/需求清单更新联调状态。
- **当前进展**：
  - 完成 API 客户端封装与 Session/PlanList 上下文改造，页面已统一使用状态容器加载计划列表并暴露刷新/登出联动。
  - 新增 `src/mocks` 计划数据源与会话生成器，并以 Node Test 验证 API 客户端错误映射及 Mock 过滤/分页逻辑，为后续组件与状态单测奠定基线。
  - 交付 `RemoteState` 通用状态呈现组件与 Ant Design 风格的筛选表单骨架，可在不触发二次请求的情况下缓存负责人/状态/关键字条件并复用 Mock 分析结果。
  - 引入离线 DatePicker/Pagination 组件与计划筛选时间窗口治理，表格支持分页切换、页容量调整，Mock 层补充时间交集过滤与单元测试校验。
  - 完成分页结果缓存与计划概要索引，缓存命中时提示数据来源并记录最后更新时间，为计划详情预加载与离线浏览提供基础数据。
  - 构建计划详情预览卡片，复用缓存索引高亮列表选中项并展示负责人、时间窗、参与人等摘要，为后续详情/时间线接口预留占位。
  - 梳理计划详情数据模型与 Mock 接口，新增时间线与提醒策略占位区块，详情状态容器支持手动刷新、缓存命中提示与错误反馈，分页缓存限制避免无限增长。
  - 抽离计划详情缓存工具模块，复用 TTL/淘汰策略，并新增 Node Test 覆盖缓存命中、超限淘汰与保留策略，同时修复 `npm run build` 在 `App.tsx` 的语法错误导致的编译阻塞。
  - 归一化计划详情、时间线与提醒载荷，统一标签、参与人、节点层级的排序与去重规则，再写入缓存前即完成校正，降低真实接口差异带来的 UI 偏差。
  - 交付计划节点树形概览组件，结合多语言标签输出顺序、执行人、时长与结果摘要，并与时间线/提醒区块复用加载、空态与错误处理逻辑。
  - ✅ 依据计划状态切换详情设计/执行模式，执行态高亮当前节点并锁定已完成节点、提示切换回设计态；模式提示面板拆分为可复用组件嵌入详情分区，PlanPreview 依据 `PlanDetail.status` 映射模式并向节点树与操作面板传递标记以控制编辑，设计态持续开放节点编辑入口；状态容器暴露模式与当前节点信息，并以新增单元测试覆盖取消态、设计↔执行切换及回退草稿场景。
  - 对接节点执行与提醒更新接口，提供通用弹窗采集操作者、交接对象与提醒偏移，调用成功后刷新缓存并以多语言文案反馈状态。
  - 完成节点/提醒接口的错误码联调，前端在操作失败时透出后端提示并在成功写入后高亮最新时间线条目同步操作日志。
  - 在节点及提醒操作失败时增加重试按钮与参数回填入口，允许用户修正输入后再次提交；同时提供时间线类别筛选与过滤提示，避免筛选条件掩盖最新操作日志。
  - 梳理计划详情时间线筛选与缓存依赖，记录筛选快照并同步缓存淘汰策略，使计划切换、缓存命中和强制刷新后仍能复用有效筛选。
  - 同步计划详情选中态与时间线筛选至 URL 查询参数，刷新或分享链接后仍可恢复筛选，并在浏览器历史切换时回放前端状态。
  - 抽象轻量级路由容器并接管 `/plans/:planId` 详情路由，统一列表点击、预览关闭与历史导航的跳转行为，为迭代 #3 的路由重构铺设骨架并保持筛选参数同步。
  - 计划列表筛选条件与分页状态写入 URL 查询参数并响应浏览器历史返回，刷新或分享链接后能恢复列表视图，并与详情查询参数协同。
  - 封装计划详情时间线面板为可复用组件，统一筛选、提示与高亮逻辑，并新增时间线筛选导出工具以支撑 Node Test 验证。
  - 抽离计划列表面板与详情预览为 `PlanListBoard` 组件，收敛筛选、分页、缓存提示与节点/提醒预览交互，同时提炼负责人提取工具，降低后续路由重构耦合度。
  - ✅ 重构 `HeaderNav` 组件承载品牌标识与固定导航，Session 容器同步输出角色权限与用户菜单数据源；未登录仅展示登录入口，鉴权后按角色渲染一级菜单及下拉项，并在导航接口异常或 403 场景下展示状态徽章并降级为 Mock 提示。
  - ✅ 新增前端路由授权校验，遇到未授权路径时展示 403 占位与返回概览按钮，防止出现无提示的空白页面。
  - ✅ 升级计划列表多视图为 Tabs + Segmented 联动，新增客户 List/Tree 视图与 Calendar 日历视图，复用派生聚合与事件映射，并针对日历即将开始区块按时间锚点筛选未来事件；Node Test 验证客户/日期分组与锚点推断结果。

### 迭代 #3 — 计划列表筛选与详情路由（规划中）
- **范围**：扩展计划列表 UI，加入负责人/关键字筛选控件，搭建计划详情视图的基本骨架。
- **依赖接口**：
  - `GET /api/v1/plans`（分页、负责人、关键字筛选）。
  - `GET /api/v1/plans/{id}`（计划详情）。
- **预期实现**：
  - 在需求清单中拆解筛选/详情接口的契约，若后端未交付则提供 Mock 响应。
  - 建立路由结构（例如 React Router），并支持多语言路径/文案。
- **验证**：
  - 单元测试覆盖筛选参数拼装与详情加载流程。
  - 若后端完成接口，执行模拟联调并在需求清单标记完成。

### 迭代 #4 — 提醒策略与驾驶舱可视化（规划中）
- **范围**：实现提醒策略列表/编辑 UI，补充驾驶舱关键指标小组件。
- **依赖接口**：
  - `GET /api/v1/plans/{id}/reminders`
  - `PUT /api/v1/plans/{id}/reminders`
  - `GET /api/v1/plans/analytics`
- **预期实现**：
  - Mock 层覆盖提醒策略与分析数据，待后端交付后联调。
  - 构建表单验证、调度策略预览与多语言描述。
- **验证**：
  - 单元测试覆盖提醒策略的增删改和错误提示。
  - 联调通过后在需求清单标记「前端完成」。

### 迭代 #5 — 错误治理与性能优化（规划中）
- **范围**：统一异常边界、权限提示、加载骨架与缓存策略，评估代码拆分。
- **预期实现**：
  - 建立 Error Boundary、多语言错误字典与日志上报占位。
  - 优化打包配置、引入代码分割或懒加载。
  - 持续补齐测试并整理文档。

## 关键接口速览
| 模块 | HTTP 方法 | 路径 | 说明 | 当前状态 |
| --- | --- | --- | --- | --- |
| 鉴权 | POST | `/api/v1/auth/login` | 登录，返回 Token、过期时间与角色 | 已实现，支持联调 |
| 鉴权 | GET | `/api/v1/auth/me` | 查询当前登录用户 | 待后端确认多语言头处理 |
| 运维计划 | GET | `/api/v1/plans` | 计划列表，支持分页/筛选 | 已实现（需分页参数约定） |
| 运维计划 | GET | `/api/v1/plans/{id}` | 计划详情 | 已提供，后续详情视图使用 |
| 运维计划 | GET | `/api/v1/plans/{id}/timeline` | 时间线 | 计划后续迭代引用 |
| 提醒策略 | GET | `/api/v1/plans/{id}/reminders` | 提醒策略查询 | 待联调 |
| 提醒策略 | PUT | `/api/v1/plans/{id}/reminders` | 更新提醒策略 | 待联调 |
| 驾驶舱 | GET | `/api/v1/plans/analytics` | 计划统计分析 | 待联调 |

> 若后端接口发生变更，需在需求清单与 README 协同章节记录，同时更新本表。

## Mock 与测试策略
- **Mock 工具**：优先考虑使用 [MSW](https://mswjs.io/) 或自定义 Fetch 拦截器；Mock 文件放置在 `frontend/src/mocks`，并提供独立的开关控制。
- **单元测试**：后续将引入 Jest + React Testing Library（或 Vitest）以覆盖组件逻辑；Mock 数据需与需求清单中声明的契约保持一致。
- **端到端验证**：当关键流程成型后，可引入 Playwright 进行回归测试；受限于当前环境可根据需求决定是否实施。

## 依赖与风险
- 后端接口分页与筛选契约需最终敲定，否则计划列表功能需长期依赖 Mock 数据。
- 多语言资源文件需要后端/产品同步维护，避免中日文 key 缺失导致渲染异常。
- 登录 Token 续期策略尚未确认，后续需在需求清单中补齐并评估前端自动刷新机制。

## 更新记录
- 2025-09-28：文档初始化，建立前后端协同规范与迭代路线图。
