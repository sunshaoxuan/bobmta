<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bob.mta.modules.plan.persistence.PlanActionHistoryMapper">

    <resultMap id="PlanActionHistoryResultMap" type="com.bob.mta.modules.plan.persistence.PlanActionHistoryEntity">
        <id property="actionId" column="action_id"/>
        <result property="planId" column="plan_id"/>
        <result property="nodeId" column="node_id"/>
        <result property="actionType" column="action_type"
                javaType="com.bob.mta.modules.plan.domain.PlanNodeActionType"/>
        <result property="actionRef" column="action_ref"/>
        <result property="triggeredAt" column="triggered_at"/>
        <result property="triggeredBy" column="triggered_by"/>
        <result property="status" column="status"
                javaType="com.bob.mta.modules.plan.domain.PlanActionStatus"/>
        <result property="messageKey" column="message_key"/>
        <result property="errorMessage" column="error_message"/>
        <result property="context" column="context"
                typeHandler="com.bob.mta.common.mybatis.StringMapJsonTypeHandler"/>
        <result property="metadata" column="metadata"
                typeHandler="com.bob.mta.common.mybatis.StringMapJsonTypeHandler"/>
    </resultMap>

    <insert id="insert" parameterType="com.bob.mta.modules.plan.persistence.PlanActionHistoryEntity">
        INSERT INTO mt_plan_action_history (
            action_id,
            plan_id,
            node_id,
            action_type,
            action_ref,
            triggered_at,
            triggered_by,
            status,
            message_key,
            error_message,
            context,
            metadata)
        VALUES (
            #{actionId},
            #{planId},
            #{nodeId},
            #{actionType},
            #{actionRef},
            #{triggeredAt},
            #{triggeredBy},
            #{status},
            #{messageKey},
            #{errorMessage},
            #{context, typeHandler=com.bob.mta.common.mybatis.StringMapJsonTypeHandler},
            #{metadata, typeHandler=com.bob.mta.common.mybatis.StringMapJsonTypeHandler})
        ON CONFLICT (action_id) DO UPDATE SET
            triggered_at = EXCLUDED.triggered_at,
            triggered_by = EXCLUDED.triggered_by,
            status = EXCLUDED.status,
            message_key = EXCLUDED.message_key,
            error_message = EXCLUDED.error_message,
            context = EXCLUDED.context,
            metadata = EXCLUDED.metadata
    </insert>

    <select id="findByPlanId" resultMap="PlanActionHistoryResultMap">
        SELECT action_id,
               plan_id,
               node_id,
               action_type,
               action_ref,
               triggered_at,
               triggered_by,
               status,
               message_key,
               error_message,
               context,
               metadata
        FROM mt_plan_action_history
        WHERE plan_id = #{planId}
        ORDER BY triggered_at ASC, action_id ASC
    </select>

    <delete id="deleteByPlanId">
        DELETE FROM mt_plan_action_history
        WHERE plan_id = #{planId}
    </delete>
</mapper>
