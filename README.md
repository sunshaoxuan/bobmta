# BOB MTA Maintain Assistants 平台 - 阶段四持久化与集成基线

本仓库根据《BOB MTA（Maintain Assistants）综合运维平台 详细设计说明书》分阶段实现平台。阶段四聚焦于将内存实现迁移到可持久化架构、铺设仓储抽象，并为即将到来的数据库与外部服务集成做好准备。本轮开始在不影响业务契约的前提下分离存储层，让后续引入 MyBatis、PostgreSQL 及对象存储时能够平滑切换。

## 阶段四迭代进度

### 🌐 多语言策略
- 产品默认语言为 **日文（ja-JP）**，可选语言包提供 **中文（zh-CN）**。
- 所有面向用户的字符串必须通过资源文件维护，严禁在代码中写死具有语种特征的文本。
- 前端位于 `frontend/src/i18n/messages.ts`，后端位于 `backend/src/main/resources/i18n/`，提交新功能时请同步更新多语言资源。
- 单元测试若需断言文案，应通过资源方法或使用无语种特征的占位字符串。
- 后端抛出的 `BusinessException`、`IllegalArgumentException` 等涉及用户提示的消息必须调用 `Localization.text` 或同级工具获取资源文案，禁止直接写入自然语言字符串。
- 新增或调整文案时需先在 `LocalizationKeys` 中登记键名，再同步维护 `messages.properties` / `messages_ja.properties` / `messages_zh.properties` 以及必要的前端映射，保持语言包完整。

### ✅ 已完成
- 迭代 #1：建立运维计划仓储抽象，支撑持久化改造的统一入口。
  - 引入 `PlanRepository` 接口与 `InMemoryPlanRepository` 实现，统一计划、节点、提醒策略的存取与 ID 生成逻辑。
  - 重构 `InMemoryPlanService` 依赖仓储接口，移除内部自管的并发容器，让业务逻辑与持久化实现解耦。
  - 同步更新计划控制层、服务层与标签模块单测依赖，并新增仓储单测覆盖 ID 生成与存储行为，确保编译期校验通过。

### 🔄 正在进行
- 设计运维计划领域到数据库表结构的字段映射，拆解计划、节点、提醒策略与活动日志的 MyBatis 映射文件。
- 梳理控制层到仓储层的事务边界与审计写入顺序，明确未来切换至数据库后的并发与一致性策略。
- 与前端、模板、文件团队对齐持久化后接口契约不变性，规划阶段四同步需要联调的验收用例。

### ⏭️ 下一步
- 实现基于 MyBatis 的 `PlanRepository` 持久化版本，并补充启动时的初始化脚本与数据迁移策略。
- 让提醒策略、时间线与附件模块共用新的仓储抽象，完成计划模块持久化改造的闭环。
- 推进对象存储、消息通知等外部集成的配置抽象，准备阶段四后续迭代的集成联调。

## 阶段三交付回顾

### ✅ 完成清单
- 迭代 #1：为用户管理接口补齐审计日志与管理员守卫，保障敏感操作可追踪。
- 迭代 #2：重构创建/激活用户返回结构，补充激活链接透出与服务契约对齐。
- 迭代 #3：梳理客户、自定义字段、标签控制器依赖，统一实体校验与内存实现。
- 迭代 #4：实现运维计划的全生命周期操作、节点执行流与 ICS 导出能力。
- 迭代 #5：记录计划取消原因/操作人/时间，在详情、列表及 ICS 中暴露，并新增控制层、服务层单测验证。
- 迭代 #6：收紧运维计划执行状态校验，补全审计前后镜像，并扩展边界用例测试。
  - 限制计划仅在已发布且处于活动状态时才能启动或完成节点，阻断设计态及已取消计划的误操作。
  - 在发布、取消与节点执行接口中记录审计前后快照，保留状态和执行信息的完整变更轨迹。
  - 扩充计划服务与控制器单测，覆盖未发布/已取消计划及节点未启动即完成等边界场景。
- 迭代 #7：构建运维计划时间线服务，串联计划发布、节点执行、完成等关键活动。
  - 为计划领域模型新增活动轨迹，记录创建、发布、取消、节点执行与计划完成等事件细节。
  - 暴露 `/api/v1/plans/{id}/timeline` API 及详情响应时间线，便于前端渲染执行追踪视图。
  - 更新计划控制器与服务单元测试，验证时间线覆盖节点生命周期及完结场景，完成阶段三交付清单。
- 迭代 #8：完善运维计划提醒策略与多渠道通知能力，提供统一的策略配置与预览服务。
  - 在计划详情中返回提醒策略摘要，并为管理端提供 `/api/v1/plans/{id}/reminders` 查询与更新接口。
  - 预置默认的邮件、短信、IM 组合规则，支持管理员按触发时机、渠道与模板自定义提醒策略。
  - 新增 `/api/v1/plans/{id}/reminders/preview` 接口，按基准时间计算未来提醒时间点，支撑前端日程与通知视图。
- 迭代 #9：打通运维计划节点与文件服务，补齐执行证据的多维透出能力，完成阶段三交付收尾。
  - 为节点执行响应增加附件清单，携带文件名、类型、大小与下载地址，便于前端直接渲染凭证。
  - `GET /api/v1/plans/{id}` 详情与节点执行接口在返回值中补充附件元数据，审计记录也同步捕获新增快照。
  - 调整控制器单测覆盖上传场景，校验附件下载地址与审计日志写入，完成计划模块与文件模块的内聚。
- 迭代 #10：构建运维计划驾驶舱分析视图，提供状态分布与逾期风险洞察。
  - 新增 `/api/v1/plans/analytics` 接口，支持按租户与时间范围聚合计划状态、逾期数量与未来执行队列。
  - 计划服务补充统计模型，返回节点进度、负责人等关键信息，支撑控制台驾驶舱渲染。
  - 扩展控制层与服务层单元测试覆盖分析场景，验证取消、发布、逾期等状态变更会实时反映在统计结果中。
- 迭代 #11：交付运维计划负责人交接能力，支持执行过程中的安全移交。
  - 新增 `/api/v1/plans/{id}/handover` 接口，可指定新负责人、同步参与人并写入交接备注。
  - 计划服务新增交接校验，阻止已结束计划重复移交，并将交接详情写入时间线活动。
  - 扩充控制器与服务层单测，验证交接后时间线、审计记录与参与人列表保持一致。

### 🔄 后续跟进
- 阶段三交付内容已全部完成，后续持续优化与集成工作将在阶段四迭代中推进。

### ⏭️ 后续规划
- 阶段三无遗留需求，所有增量均已纳入阶段四路线图。

## 项目结构

```
backend/   # Spring Boot 3 后端服务，聚合阶段三/四功能所需的 REST API 与仓储抽象
frontend/  # React + Vite 前端占位（内置日文默认语言，可切换简体中文）
```

## 后端快速开始

```bash
cd backend
mvn spring-boot:run
```

应用启动后可尝试以下示例接口：

| 接口 | 描述 | 备注 |
| --- | --- | --- |
| `POST /api/v1/auth/login` | 账号登录（内存账户） | 预置账号：`admin`/`admin123`、`operator`/`operator123` |
| `GET /api/v1/auth/me` | 获取当前登录用户信息 | 需要在 `Authorization: Bearer <token>` 中携带登录返回的 Token |
| `POST /api/v1/users` | 创建系统用户并发放激活链接 | 需管理员角色 |
| `POST /api/v1/users/activation` | 校验激活 Token 并启用账号 | 激活接口对未登录用户开放 |
| `POST /api/v1/users/{id}/activation/resend` | 重新发放激活链接 | 需管理员角色 |
| `PUT /api/v1/users/{id}/roles` | 更新用户角色集合 | 角色名自动标准化为 `ROLE_*` |
| `GET /api/v1/customers` | 客户列表 | 支持按地区与关键字过滤（内存数据） |
| `GET /api/v1/customers/{id}` | 客户详情 | 展示联系人、自定义字段等结构 |
| `GET /api/v1/custom-fields` | 自定义字段定义列表 | 支持动态档案字段配置 |
| `PUT /api/v1/custom-fields/customers/{id}` | 更新客户自定义字段值 | 支持增改非结构化字段 |
| `GET /api/v1/plans` | 运维计划列表 | 支持按客户、状态、时间范围过滤并返回进度摘要 |
| `POST /api/v1/plans` | 创建运维计划 | 接收节点树结构与参与人列表，初始状态为 DESIGN |
| `PUT /api/v1/plans/{id}` | 更新运维计划 | DESIGN 状态下允许调整时间、参与人及节点定义 |
| `DELETE /api/v1/plans/{id}` | 删除运维计划 | 仅 DESIGN 计划可删除，删除时写入审计日志 |
| `POST /api/v1/plans/{id}/publish` | 发布运维计划 | 根据开始时间切换为 SCHEDULED/IN_PROGRESS，并记录审计 |
| `POST /api/v1/plans/{id}/cancel` | 取消运维计划 | 写入取消原因/操作者并终止计划 |
| `POST /api/v1/plans/{id}/nodes/{nodeId}/start` | 开始执行节点 | 切换节点状态为 IN_PROGRESS，驱动计划进入执行态 |
| `POST /api/v1/plans/{id}/nodes/{nodeId}/complete` | 完成节点 | 校验已启动后方可完成，支持提交结果、日志与附件 |
| `GET /api/v1/plans/{id}` | 运维计划详情 | 展示流程节点树形结构及执行进度 |
| `GET /api/v1/plans/{id}/timeline` | 运维计划时间线 | 返回计划与节点的关键活动轨迹 |
| `GET /api/v1/plans/{id}/reminders` | 查看运维计划提醒策略 | 返回默认及自定义的提醒规则列表 |
| `PUT /api/v1/plans/{id}/reminders` | 更新运维计划提醒策略 | 支持配置渠道、模板、触发时机并记录审计 |
| `GET /api/v1/plans/{id}/reminders/preview` | 预览运维计划提醒触达计划 | 基于时间窗口计算未来触达时间点 |
| `GET /api/v1/plans/{id}/ics` | 导出单计划 ICS | 生成 `text/calendar` 文件，可导入主流日历 |
| `GET /api/v1/calendar/tenant/{tenant}.ics` | 租户计划订阅 | 输出租户可见计划的 ICS 订阅源 |
| `GET /api/v1/tags` | 标签管理 | 支持按作用域筛选、关联客户/计划 |
| `POST /api/v1/templates/{id}/render` | 模板渲染 | 根据上下文替换占位符，返回渲染结果 |
| `POST /api/v1/files` | 文件元数据登记 | 生成对象存储键及下载地址 |
| `GET /api/v1/audit-logs` | 审计日志查询 | 需管理员角色 |
| `GET /api/ping` | 健康检查 | 返回 `{status: ok}` |

### 测试与覆盖率

```bash
cd backend
mvn verify
```

该命令会运行全部单元测试并在 `backend/target/site/jacoco/index.html` 生成 Jacoco 覆盖率报表。若初次执行无法下载依赖，可根据环境配置 Maven 镜像。

## 下一步计划

- 引入 PostgreSQL + MyBatis 持久化层，实现标签、模板、文件、自定义字段等实体的数据库存储；
- 与前端协同定义 OpenAPI 契约，扩展状态管理与国际化能力；
- 补充更多集成测试并接入 CI，持续维持覆盖率在 80% 以上；
- 推进对象存储与日历订阅等外部集成，完善阶段四及之后的联调准备。
