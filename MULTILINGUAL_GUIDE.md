# 多语言架构规范

本规范是 BOB MTA Maintain Assistants 平台在多语言资源与数据处理方面的**强约束性**指导文件，适用于全部服务端与前端项目。任何新功能、Bug 修复、重构都必须遵守此处的规则，否则视为违背产品设计。

## 语言策略
- 产品默认语言：日文（`ja-JP`）。
- 可选语言包：简体中文（`zh-CN`），未来追加语言必须经产品批准并补齐资源。
- 未声明语种时一律回落到默认语言，禁止返回空字符串或混用不同语种。

## 静态资源国际化
1. **资源存放位置**：所有用户可见的界面、错误提示、审计文案、种子数据描述等静态字符串必须维护在 `backend/src/main/resources/i18n/messages*.properties` 中。
2. **键名管理**：
   - 在 `LocalizationKeys` 中登记唯一键名，禁止直接书写常量字符串。
   - 新增键名时需同步维护所有语言文件，缺失翻译时应先提供日文默认值。
3. **后端访问**：
   - 服务端通过 `Localization.text(key, locale, args...)` 获取资源，并确保在控制器/服务层任何可能触达用户的路径上使用该工具。
   - 抛出 `BusinessException`、`IllegalArgumentException` 等提示型异常时必须使用资源键，禁止拼接自然语言。
4. **接口暴露**：
   - `/api/v1/i18n/messages` 负责向前端发送资源包，响应包含版本号、支持的语言列表及 `messages.properties` 键值对。
   - 该接口允许匿名访问，以便登录页等公共视图在无会话状态时加载文案。
5. **前端加载**：
   - 前端初始化时需检查 `localStorage` 中的 `bobmta.localization.bundle` 缓存；若无缓存或版本失效，调用后端接口刷新。
   - 前端组件仅通过资源键读取文案，不得内联翻译文本。

## 数据多语言
1. **领域模型**：
   - 使用 `MultilingualText` 值对象描述实体字段的多语言内容，由 `MultilingualTextRepository` 持久化。
   - 服务层在创建、更新实体时必须要求调用方提供默认语言值，可选附带其他语言。
2. **服务能力**：
   - `MultilingualTextService` 负责合并新旧翻译、校验默认语言存在并在缺失时抛出本地化异常。
   - 查询时提供目标语言参数，若指定语言不存在则回退到默认语言。
3. **API 契约**：
   - 控制层返回 `MultilingualTextPayload`（含 `defaultLocale`、`values`）供前端渲染。
   - 接受 `Accept-Language` 请求头，借助 `LocalePreferenceService` 解析当前语种并贯穿仓储、服务、控制器全链路。
4. **种子数据**：
   - 预置计划、模板、客户等初始数据必须通过 `MultilingualText` 写入并提供至少日文翻译。

## 开发流程要求
- 新增代码、单元测试、前端组件中严禁出现任何具有语种特征的字面量字符串。
- 提交包含多语言改动时，务必更新资源文件、`LocalizationKeys`、多语言测试用例以及本文档引用的约束。
- 在 Code Review 中，审查人员需验证所有新增文案是否存在资源键及多语言值。

## 测试与验证
- 单元测试如果需要断言文案，须调用资源加载函数或断言键名，而非直接比较翻译结果。
- 集成测试应覆盖 `Accept-Language` 不同取值的回退逻辑，确保缺省情况下返回日文文本。

## 变更控制
- 对本文档的修改需经过架构负责人审批，并同步更新 README 中的引用说明。
- 若后续引入新语言，应在资源文件、缓存版本策略以及客户端语言切换交互方面一并交付。
